---
import { getCollection, type CollectionEntry } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import { Image } from 'astro:assets'

// Obtener el markdown de la colección "manifiesto"
const entries = await getCollection('manifiesto')
const entry = entries.find((e) => e.slug === 'manifiesto')

if (!entry) {
	throw new Error('No se encontró intro.md')
}

// Renderizar contenido
const { Content } = await entry.render()

// Tipado correcto sin usar `any`
const { title, description, author, pubDate, image } = (
	entry as CollectionEntry<'manifiesto'>
).data
// Importar imágenes de manera dinámica
const manifiestoImages = import.meta.glob(
	'../../assets/manifiestoimages/**/*.{jpeg,jpg,png,gif}',
	{ eager: true, as: 'url' }
) as Record<string, string>

// Normalizar el mapa para indexar por NOMBRE DE FICHERO (ej: 'portada.png')
const manifiestoImagesByFile: Record<string, string> = Object.fromEntries(
	Object.entries(manifiestoImages).map(([path, url]) => {
		const fileName = path.split('/').pop() ?? path
		return [fileName, url]
	})
)

// Aquí usamos SOLO image.url porque el tipo es { url: string; alt?: string }
const imagePath = image?.url ?? ''
const imageFileName = imagePath ? (imagePath.split('/').pop() ?? '') : ''

const coverImageUrl = imageFileName
	? (manifiestoImagesByFile[imageFileName] ?? null)
	: null
---

<BaseLayout title={title} description={description}>
	<section class="px-4 py-18 mx-auto max-w-4xl">
		<header class="text-center mb-10">
			{
				description && (
					<p class="text-gray-600 dark:text-gray-300 mb-3 text-lg">
						{description}
					</p>
				)
			}
			{
				(author || pubDate) && (
					<p class="text-sm text-gray-500">
						{author && `✍️ ${author}`}
						{pubDate && ` — ${new Date(pubDate).toLocaleDateString('es-ES')}`}
					</p>
				)
			}
		</header>

		{
			coverImageUrl && (
				<div class="flex justify-center mb-10">
					<Image
						src={coverImageUrl}
						alt={image?.alt || 'Imagen de presentación'}
						width={1024}
						height={600}
						class="rounded-3xl shadow-md"
						loading="eager"
					/>
				</div>
			)
		}

		<article class="prose prose-lg dark:prose-invert mx-auto leading-relaxed">
			<Content />
		</article>
	</section>
</BaseLayout>
